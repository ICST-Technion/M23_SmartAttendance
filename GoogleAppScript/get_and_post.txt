//   Based on code published by Martin Hawksey
//   https://hawksey.info/blog/2014/07/google-sheets-as-a-database-insert-with-apps-script-using-postget-methods-with-ajax-example/


// Usage
//  1. Enter sheet name where data is to be written below
//  2. Run > setup
//
//  3. Publish > Deploy as web app 
//    - enter Project Version name and click 'Save New Version' 
//    - set security level and enable service (most likely execute as 'me' and access 'anyone, even anonymously) 
//
//  4. Copy the 'Current web app URL' and post this in your form/script action 
//
//  5. Insert column names on your destination sheet matching the parameter names of the data you are passing in (exactly matching case)

var SCRIPT_PROP = PropertiesService.getScriptProperties(); // new property service
var LOG_ENTRY_SIZE = 2;
var USER_INFO_SIZE = 2;

function doGet(e) {
    return get_all_approved_users(e);
}

function doPost(e) {
  if(e.postData.contents !== undefined){
    if(e.parameter.add_user !== undefined){
      add_pending_user(e.postData.contents);
    }
    if(e.parameter.add_log !== undefined){
      add_log_entry(e.postData.contents);
    }
    return ContentService.createTextOutput(JSON.stringify({ "result": "test", "postData": e.postData.contents}));
  }
  return ContentService.createTextOutput(JSON.stringify({ "result": "empty"}));
}

function isApproved(arr) {
  return arr[2] == "V";
};

function get_all_approved_users(e){
  var lock = get_lock();
  var sheet = get_sheet(0);
  var lastRow = sheet.getLastRow();
  var user_list = sheet.getRange("A2:C" + lastRow);
  var values;
  if (user_list !== undefined) 
  {
      try {values = user_list.getValues();}
      catch (error) {return ContentService.createTextOutput(JSON.stringify({ "result": "error", "NoMatchingHeaderError": error })); }
  }

  var data = values.filter(isApproved);
  data.forEach(remove_v);
  Logger.log(data);
  lock.releaseLock();
  return ContentService.createTextOutput(JSON.stringify({ "result": "success", "data": data }));
}

function remove_v(value){
  value.splice(2,1);
}

function add_pending_user(user_info){
  var lock = get_lock();
  var user_list_sheet = get_sheet(0);
  if(user_info != undefined){ 
    var user_info_arr = Utilities.parseCsv(user_info)[0];
    if(user_info_arr.length == USER_INFO_SIZE){
      var user_id = user_info_arr[0];
      var user_uid = user_info_arr[1];
      var row = user_list_sheet.getLastRow() + 1;
      user_list_sheet.getRange(row, 1, 1, 2).setValues([[user_id, user_uid]]);
    }
    else{
      Logger.log("Post request not in correct csv format");
      return ContentService.createTextOutput(JSON.stringify({ "result": "error"}));
    }
  }
  else{
    Logger.log("Missing user info from post request");
    return ContentService.createTextOutput(JSON.stringify({ "result": "error"}));
  }
  lock.releaseLock();
}

function add_log_entry(log){
  var lock = get_lock();
  var attendance_log_sheet = get_sheet(1);
  var user_list_sheet = get_sheet(0);
  if(log != undefined){
    var log_arr = Utilities.parseCsv(log)[0];
    var user_uid = log_arr[0];
    // checks
    if(log_arr.length == LOG_ENTRY_SIZE){
      var row = attendance_log_sheet.getLastRow() + 1;
      attendance_log_sheet.getRange(row, 2, 1, 2).setValues([log_arr]);
      var user_id_index = user_list_sheet.getRange(1,2,user_list_sheet.getLastRow()).createTextFinder(user_uid).matchCase(false).findNext();
      var user_id = user_list_sheet.getRange(user_id_index.getRow(), 1).getValue();
      attendance_log_sheet.getRange(row, 1).setValue(user_id);
    }
    else{
      Logger.log("Post request not in correct csv format");
      return ContentService.createTextOutput(JSON.stringify({ "result": "error"}));
    }
  }
  else{
    Logger.log("Missing log from post request");
    return ContentService.createTextOutput(JSON.stringify({ "result": "error"}));
  }

  lock.releaseLock();
}

function get_lock(){
  var lock = LockService.getPublicLock();
  lock.waitLock(30000);  // wait 30 seconds before conceding defeat.
  return lock;
}

function get_sheet(index){
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheets()[index];
  return sheet;
}

function setup() {
    var doc = SpreadsheetApp.getActiveSpreadsheet();
    SCRIPT_PROP.setProperty("key", doc.getId());
}
